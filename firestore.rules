rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isFamilyOwner(familyId) {
      // Check if user is the owner listed in the family document
      return request.auth != null && 
        get(/databases/$(database)/documents/families/$(familyId)).data.ownerId == request.auth.uid;
    }

    // ============================================
    // USER DATA
    // ============================================

    // Users: Users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // User Preferences (EC mode toggle, etc.)
    match /userPreferences/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Subscriptions: Read by owner, write by Cloud Functions only
    match /subscriptions/{userId} {
      allow read: if isOwner(userId);
      allow write: if false; // Cloud Functions use Admin SDK
    }

    // ============================================
    // FAMILY DATA  
    // ============================================

    // Families: Create allowed if auth; Read/Write only by owner
    match /families/{familyId} {
      allow create: if request.auth != null;
      allow read, write: if resource.data.ownerId == request.auth.uid;
    }

    // Children: Linked by familyId
    match /children/{childId} {
      allow read, update, delete: if isFamilyOwner(resource.data.familyId);
      allow create: if isFamilyOwner(request.resource.data.familyId);
    }

    // ABC Entries
    match /abcEntries/{entryId} {
      allow read, update, delete: if isFamilyOwner(resource.data.familyId);
      allow create: if isFamilyOwner(request.resource.data.familyId);
    }

    // Strategy Cards
    match /strategies/{strategyId} {
      allow read, update, delete: if isFamilyOwner(resource.data.familyId);
      allow create: if isFamilyOwner(request.resource.data.familyId);
    }

    // ============================================
    // SHARE PACKETS - SECURED
    // ============================================
    
    // Share Packets: Owner has full control
    // NO PUBLIC READ - all public access goes through Cloud Function
    match /sharePackets/{packetId} {
      allow read, write: if isFamilyOwner(resource.data.familyId);
      allow create: if isFamilyOwner(request.resource.data.familyId);
      // REMOVED: allow read: if request.time < resource.data.expiresAt;
      // Public access now handled by getPublicSharePacket Cloud Function
    }
    
    // ============================================
    // CONFIG & PUBLIC DATA
    // ============================================

    // App Config (read-only for clients, admin writes via Console)
    match /config/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // Public Resources (Learning Hub - if ever moved to Firestore)
    match /resources/{resourceId} {
      allow read: if true;
      allow write: if false; // Admin only
    }
  }
}
